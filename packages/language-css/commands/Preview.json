{
  "beforeRunningCommand": "nop",
  "command": "#!/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/bin/ruby\n\nLIPSUM = \"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.\"\n\ndef tag_preview(selector_list)\n\thtml = 'TEXT_INSERT'\n\tselectors = selector_list.split(/\\s+/)\n\tlast_tag = ''\n\ttext_insert = \"Generated preview for CSS selector #{selector_list}.\"\n\n\tstar_class = ''\n\tstar_id = ''\n\thtml_class = ''\n\thtml_id = ''\n\tbody_class = ''\n\tbody_id = ''\n\n\tselectors.reverse.each do | selector |\n\t\tsinglet = false\n\t\ttag = selector.clone\n\t\tif (tag =~ /#(.+)/)\n\t\t\tid = (tag.scan(/#(.+)/))[0][0]\n\t\t\tid.gsub!(/\\..+/, '')\n\t\telse\n\t\t\tid = nil\n\t\tend\n\t\tif (tag =~ /\\.(.+)/)\n\t\t\tcls = (tag.scan(/\\.(.+)/))[0][0]\n\t\t\tcls.gsub!(/\\./, ' ')\n\t\t\tcls.gsub!(/\\#.+/, '')\n\t\telse\n\t\t\tcls = nil\n\t\tend\n\n\t\ttag.downcase!\n\t\ttag.sub!(/#(.+)/, '');\n\t\ttag.sub!(/\\.(.+)/, '');\n\t\ttag.sub!(/:.+/, '')\n\n\t\tcase tag\n\t\twhen '*'\n\t\t\tstar_class = \" #{cls}\" if cls\n\t\t\tstar_id = \" id=\\\"#{id}\\\"\" if id\n\t\t\tcls = nil\n\t\t\tid = nil\n\t\t\ttag = 'div'\n\t\twhen 'body'\n\t\t\tbody_class = \" #{cls}\" if cls\n\t\t\tbody_id = \" id=\\\"#{id}\\\"\" if id\n\t\t\tcls = nil\n\t\t\tid = nil\n\t\t\ttag = 'div'\n\t\twhen 'html'\n\t\t\thtml_class = \" #{cls}\" if cls\n\t\t\thtml_id = \" id=\\\"#{id}\\\"\" if id\n\t\t\tcls = nil\n\t\t\tid = nil\n\t\t\ttag = 'div'\n\t\tend\n\n\t\tnext if tag == '+'\n\n\t\tif selector =~ /^[#.]/\n\t\t\tcase last_tag\n\t\t\twhen 'li'\n\t\t\t\ttag = 'ul'\n\t\t\twhen 'td'\n\t\t\t\ttag = 'tr'\n\t\t\twhen 'tr'\n\t\t\t\ttag = 'table'\n\t\t\twhen /^h\\d/\n\t\t\t\ttag = 'div'\n\t\t\telse\n\t\t\t\ttag = 'span'\n\t\t\tend\n\t\tend\n\n\t\tif (tag =~ /\\[(.+?)\\]/)\n\t\t\ttag_attr = (tag.scan(/\\[(.+?)\\]/))[0][0]\n\t\t\ttag.gsub!(/\\[.+?\\]/, '')\n\t\telse\n\t\t\ttag_attr = nil\n\t\tend\n\t\tpart = \"<\" + tag\n\t\tpart += \" #{tag_attr}\" if tag_attr\n\t\tpart += \" id=\\\"#{id}\\\"\" if id\n\t\tpart += \" class=\\\"#{cls}\\\"\" if cls\n\n\t\t# defaults for img tag\n\t\tcase tag\n\t\twhen 'img'\n\t\t\tpart += \" src=\\\"http://www.google.com/intl/en/images/logo.gif\\\"\"\n\t\t\tpart += \" alt=\\\"Preview of #{selector_list}\\\"\"\n\t\t\tsinglet = true\n\t\twhen 'a'\n\t\t\tpart += \" href=\\\"\\#\\\"\"\n\t\twhen 'input'\n\t\t\topen_tag = part.clone\n\t\t\tpart += \" type=\\\"radio\\\" /> Radio\"\n\t\t\tpart += \"#{open_tag} type=\\\"checkbox\\\" /> Checkbox<br />\"\n\t\t\tpart += \"#{open_tag} type=\\\"text\\\" value=\\\"Text Field\\\" />\"\n\t\t\tpart += \"#{open_tag} type=\\\"button\\\" value=\\\"Button\\\"\"\n\t\t\tsinglet = true\n\t\twhen 'select'\n\t\t\tpart += \"><option>Option 1</option><option>Option 2</option\"\n\t\t\thtml = ''\n\t\tend\n\n\t\tif (singlet)\n\t\t\tpart += \" />\"\n\t\telse\n\t\t\tpart += \">\"\n\t\t\tpart += html\n\t\t\tpart += \"</\" + tag + \">\"\n\t\tend\n\n\t\tcase tag\n\t\twhen /^h\\d/\n\t\t\ttext_insert = tag.sub(/^h(\\d+)/, \"Heading \\\\1\")\n\t\twhen 'p'\n\t\t\ttext_insert = LIPSUM\n\t\twhen 'object', 'img', 'input'\n\t\t\ttext_insert = \"\"\n\t\tend\n\n\t\thtml = part\n\t\tlast_tag = tag\n\tend\n\n\tif (last_tag)\n\t\tcase last_tag\n\t\twhen 'em', 'strong', 'b', 'i'\n\t\t\thtml = \"<p>#{html}</p>\"\n\t\twhen 'li'\n\t\t\thtml = \"<ul>#{html}</ul>\"\n\t\twhen 'td'\n\t\t\thtml = \"<table><tr>#{html}</tr></table>\"\n\t\twhen 'tr'\n\t\t\thtml = \"<table>#{html}</table>\"\n\t\twhen 'input', 'textarea', 'select'\n\t\t\thtml = \"<form method=\\\"get\\\">#{html}</form>\"\n\t\tend\n\tend\n\n\thtml = \"<div>#{html}</div>\"\n\thtml.sub!(/TEXT_INSERT/, text_insert)\n\n\treturn <<EOT\n<div class=\"__wrap_wrap\"><div class=\"__star_wrap#{star_class}\"#{star_id}><div class=\"__html_wrap#{html_class}\"#{html_id}><div class=\"__body_wrap#{body_class}\"#{body_id}>#{html}</div></div></div></div>\nEOT\nend\n\ndef preview_css(str)\n\torig_css = str.clone\n\torig_css.gsub!(/<entity\\.name\\.tag\\.wildcard\\.css>\\*<\\/entity\\.name\\.tag\\.wildcard\\.css>/, '.__star_wrap')\n\torig_css.gsub!(/<entity\\.name\\.tag\\.css>body<\\/entity\\.name\\.tag\\.css>/, '.__body_wrap')\n\torig_css.gsub!(/<entity\\.name\\.tag\\.css>html<\\/entity\\.name\\.tag\\.css>/, '.__html_wrap')\n\n\torig_css.gsub!(/<.+?>/, '')\n\torig_css.gsub!(/&lt;\\/?style\\b.*?&gt;/m, '')\n\torig_css.strip!\n\n\t#meta.selector.css -> wraps the selector\n\t#meta.property-list.css -> wraps the properties\n\trules = str.scan(/<meta\\.selector\\.css>\\s*(.+?)\\s*<\\/meta\\.selector\\.css>.*?<meta\\.property-list\\.css>(.+?)<\\/meta\\.property-list\\.css>/m)\n\n\thtml = ''\n\tcss = ''\n\trule_num = 0\n\n\trules.each do | rule |\n\t\tselector = rule[0].gsub(/<.+?>/, '')\n\t\tstyles = rule[1].gsub(/<.+?>/, '')\n\t\tstyles.gsub!(/^\\s*\\{\\n*/m, '')\n\t\tstyles.gsub!(/\\s*\\}\\s*$/m, '')\n\t\tstyles.gsub!(/\\t/, ' ' * ENV['TM_TAB_SIZE'].to_i)\n\t\tselectors = selector.split(/\\s*,\\s*/m)\n\t\tselectors.each do | single_selector |\n\t\t\trule_num += 1\n\t\t\thtml += \"<div class=\\\"__rule_clear\\\"></div>\\n\\n\" if html != ''\n\t\t\thtml += \"<div class=\\\"__rule_selector\\\">#{single_selector} <a class=\\\"__view_link\\\" href=\\\"javascript:viewCSS('__rule#{rule_num}')\\\" title=\\\"Click to toggle CSS view\\\">CSS</a><div class=\\\"__rule\\\" id=\\\"__rule#{rule_num}\\\" style=\\\"display: none\\\">#{styles}</div></div>\\n\\n\"\n\t\t\thtml += tag_preview(single_selector) + \"\\n\\n\"\n\t\tend\n\tend\n\n\tfilename = ENV['TM_FILENAME'] || 'untitled'\n\tbase = ''\n\tbase = \"<base href=\\\"file://#{ENV['TM_FILEPATH']}\\\" />\" if ENV['TM_FILEPATH']\n\n\treturn <<EOT\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \n\t\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n\t<head>\n\t\t#{base}\n\t\t<meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" />\n\t\t<meta http-equiv=\"Content-Language\" content=\"en-us\" />\n\t\t<title>CSS Preview for #{filename}</title>\n\t\t<style type=\"text/css\">\n#{orig_css}\n.__wrap_wrap {\n\tposition: relative;\n\tmargin-top: 5px;\n\tmargin-bottom: 20px;\n\tborder-top: 1px solid #ccc;\n}\n.__rule_selector {\n\tfont-family: Times;\n\tfont-size: 16px;\n\tborder-top: 1px solid #ccc;\n}\n.__rule {\n\twhite-space: pre;\n\tword-wrap: break-word;\n\tfont-family: Monaco;\n\tfont-size: 11px;\n}\n.__view_link {\n\tfont-family: Monaco;\n\tfont-size: 11px;\n}\n.__rule_clear:after {\n\tcontent: \".\"; \n\tdisplay: block; \n\theight: 0; \n\tclear: both; \n\tvisibility: hidden;\n}\n\t\t</style>\n\t\t<script type=\"text/javascript\">\n\t\tfunction viewCSS(rule_id) {\n\t\t\tvar el = document.getElementById(rule_id);\n\t\t\tif (el) {\n\t\t\t\tif (el.style.display == 'none')\n\t\t\t\t\tel.style.display = 'block';\n\t\t\t\telse\n\t\t\t\t\tel.style.display = 'none';\n\t\t\t}\n\t\t}\n\t\t</script>\n\t</head>\n\t\n\t<body>\n#{html}\n\t</body>\n</html>\nEOT\nend\n\nprint preview_css(STDIN.read)\n",
  "fallbackInput": "scope",
  "input": "selection",
  "inputFormat": "xml",
  "keyEquivalent": "^~@p",
  "name": "Preview",
  "output": "showAsHTML",
  "scope": "source.css - text.html"
}
